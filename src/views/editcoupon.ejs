<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Coupon</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>

<body class="d-flex" style="background-color: black;">

  <!-- Sidebar -->
  <%- include("partials/superadminsidebar") %>

  <!-- Main Content -->
  <div class="main-content flex-grow-1 p-4 text-dark" style="background-color:#F8FAFC;">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-6">

          <div class="page-header d-flex justify-content-between align-items-center">
            <h2>Edit Coupon</h2>
            <a href="/admin/courses/coupons" class="btn btn-danger">Cancel</a>
          </div>

          <!-- Edit Coupon Form -->
          <form action="/admin/courses/coupons/<%= coupon._id %>/edit" method="POST" class="mt-4">

            <!-- Coupon Status -->
            <div class="mb-3">
              <label class="form-label">Coupon Status</label>
              <select name="status" class="form-select">
                <option value="Active" <%= coupon.status === 'Active' ? 'selected' : '' %>>Active</option>
                <option value="Inactive" <%= coupon.status === 'Inactive' ? 'selected' : '' %>>Inactive</option>
              </select>
            </div>

            <!-- Coupon Name -->
            <div class="mb-3">
              <label class="form-label">Coupon Name</label>
              <input type="text" class="form-control" name="couponName" value="<%= coupon.couponName %>" required>
            </div>

            <!-- Description -->
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="3"><%= coupon.description %></textarea>
            </div>

            <!-- Coupon Code -->
            <div class="mb-3">
              <label class="form-label">Coupon Code</label>
              <input type="text" class="form-control" name="couponCode" value="<%= coupon.couponCode %>" required>
            </div>

            <!-- Coupon Quantity & Uses -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Coupon Quantity</label>
                <input type="number" class="form-control" name="couponQuantity" value="<%= coupon.couponQuantity %>" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Uses per Customer</label>
                <input type="number" class="form-control" name="usesPerCustomer" value="<%= coupon.usesPerCustomer %>" required>
              </div>
            </div>

            <!-- Discount Type -->
            <div class="mb-3">
              <label class="form-label">Discount Type</label>
              <select name="discountType" id="discountType" class="form-select" required>
                <option value="">-- Select --</option>
                <option value="Amount" <%= coupon.discountType === 'Amount' ? 'selected' : '' %>>Amount</option>
                <option value="Percentage" <%= coupon.discountType === 'Percentage' ? 'selected' : '' %>>Percentage</option>
              </select>
            </div>

     <!-- Amount Fields -->
<div id="amountFields" style="<%= coupon.discountType === 'Amount' ? '' : 'display:none;' %>">
  <div class="mb-3">
    <label class="form-label">Discount Amount</label>
    <input type="number" class="form-control" name="amountdiscountValue" 
      value="<%= coupon.discountType === 'Amount' ? coupon.discountValue : '' %>">
  </div>
  <div class="mb-3">
    <label class="form-label">Minimum Purchase (Amount)</label>
    <input type="number" class="form-control" name="amountminPurchase" 
      value="<%= coupon.discountType === 'Amount' ? coupon.minPurchaseAmount : '' %>">
  </div>
</div>

<!-- Percentage Fields -->
<div id="percentageFields" style="<%= coupon.discountType === 'Percentage' ? '' : 'display:none;' %>">
  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="form-label">Discount Percentage</label>
      <input type="number" class="form-control" name="discountValue" 
        value="<%= coupon.discountType === 'Percentage' ? coupon.discountValue : '' %>" min="1" max="100">
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label">Maximum Discount Amount</label>
      <input type="number" class="form-control" name="maxDiscountAmount" 
        value="<%= coupon.discountType === 'Percentage' ? coupon.maxDiscountAmount : '' %>">
    </div>
    <div class="col-md-12 mb-3">
      <label class="form-label">Minimum Purchase (Percentage)</label>
      <input type="number" class="form-control" name="percentageminPurchase" 
        value="<%= coupon.discountType === 'Percentage' ? coupon.minPurchaseAmount : '' %>">
    </div>
  </div>
</div>


            <!-- Date & Time -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Starting Date & Time</label>
                <input 
                  type="text" 
                  class="form-control datetimepicker" 
                  name="startDateTime" 
                  value="<%= coupon.startDateTime ? new Date(coupon.startDateTime).toISOString().slice(0,16) : '' %>">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Ending Date & Time</label>
                <input 
                  type="text" 
                  class="form-control datetimepicker" 
                  name="endDateTime" 
                  value="<%= coupon.endDateTime ? new Date(coupon.endDateTime).toISOString().slice(0,16) : '' %>">
              </div>
            </div>

            <!-- Scope -->
            <div class="mb-3">
              <label class="form-label">Applied To</label>
              <select class="form-select" id="appliedTo" name="scope" required>
                <option value="global" <%= coupon.scope === 'global' ? 'selected' : '' %>>Global</option>
                <option value="coursespecific" <%= coupon.scope === 'coursespecific' ? 'selected' : '' %>>For Courses</option>
              </select>
            </div>

            <!-- Course Selection -->
            <div class="mb-3" id="courseSelection" style="<%= coupon.scope === 'coursespecific' ? '' : 'display:none;' %>">
              <label class="form-label">Select Courses</label>
              <select class="form-select" id="coursesDropdown" name="courseId" multiple="multiple" style="width:100%">
                <% courses.forEach(course => { %>
                  <option value="<%= course._id %>" <%= coupon.courseId.includes(course._id.toString()) ? 'selected' : '' %>>
                    <%= course.name %>
                  </option>
                <% }) %>
              </select>
            </div>

            <!-- Save Button -->
            <div class="d-flex justify-content-end">
              <button type="submit" class="btn btn-dark">Update Coupon</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <%- include("partials/flashalerts") %>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    $(document).ready(function () {
      // Initialize select2
      $('#coursesDropdown').select2({
        placeholder: "Search and select courses",
        allowClear: true
      });

      // Show/hide course selection
      $('#appliedTo').on('change', function () {
        if ($(this).val() === 'coursespecific') {
          $('#courseSelection').show();
        } else {
          $('#courseSelection').hide();
          $('#coursesDropdown').val(null).trigger('change');
        }
      });

      // Show/hide discount fields
      $('#discountType').on('change', function () {
        if ($(this).val() === 'Amount') {
          $('#amountFields').show();
          $('#percentageFields').hide();
        } else if ($(this).val() === 'Percentage') {
          $('#percentageFields').show();
          $('#amountFields').hide();
        } else {
          $('#amountFields, #percentageFields').hide();
        }
      });
    });

    // Flatpickr datetime
    flatpickr(".datetimepicker", {
      enableTime: true,
      dateFormat: "Y-m-d H:i",
      time_24hr: true
    });
  </script>

</body>
</html>
