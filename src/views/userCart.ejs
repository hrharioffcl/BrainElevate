<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= user.fullName %> | My Learning
  </title>


  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/profile.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

</head>

<body>

  <%- include('partials/header') %>

    <!-- Profile Section -->
    <section class="profile">
      <div class="profile-card">
        <div style="margin-left:5%;">



          <div class="profile-avatar  position-relative d-inline-block">
            <img src="<%= user.profilepic || '/images/default-avatar.png' %>" alt="User" referrerpolicy="no-referrer">
            <a href="" class="btn btn-sm edit-btn position-absolute"> <i class="bi bi-pencil"></i>

            </a>

          </div>

          <div class="profile-info">
            <h2>
              <%= user.fullName %>
            </h2>

            <p><i class="bi bi-envelope-at-fill"></i>
              <%= user.email %>
            </p>
            <p><i class="fa-solid fa-location-dot"></i>
              <%= user.location %>
            </p>
          </div>
        </div>
        <div style="margin-right:5%;"> <a class="border-btn rounded-pill" href="/logout"><i
              class="fa-solid fa-person-running"></i>


            Log Out</a></div>

      </div>
      <%- include('partials/profileTabs', { activeTab: 'cart' }) %>
        <section class="learning-cart">
          <div class="cart-container">
            <h3 class="cart-title">My Cart</h3>
            <table class="table align-middle">
              <thead>
                <tr>
                  <th style="width:60%">Course</th>
                  <th class="text-end">Price</th>
                </tr>
              </thead>
              <tbody>
                <% if (cart && cart.items && cart.items.length> 0) { %>
                  <% cart.items.forEach(item=> { %>
                    <tr class="cart-row position-relative">
                      <td>
                        <div class="d-flex align-items-center">
                          <a href="/courses/<%= item.course._id %>">
                            <img src="<%= item.course.thumbnail %>" alt="Course" class="cart-course-img">
                          </a>
                          <div class="cart-details">
                            <div class="d-flex justify-content-between align-items-start">
                              <h6 class="mb-1 cart-title">
                                <a href="/courses/<%= item.course._id %>" class="cartCourse">
                                  <%= item.course.name %>
                                </a>
                              </h6>
                              <form action="/cart/remove" method="POST" class="delete-form d-inline">
                                <input type="hidden" name="itemId" value="<%= item._id %>">
                                <button type="submit" class=" remove-btn">
                                  <i class="fa-solid fa-xmark"></i>
                                </button>
                              </form>

                            </div>
                            <small class="text-muted">Course by <%= item.course.author %></small>
                          </div>
                        </div>
                      </td>


                      <td class="text-end fw-semibold">$<%= item.course.price.toFixed(2) %>
                      </td>
                    </tr>
                    <% }) %>
                      <% } else { %>
                        <tr>
                          <td colspan="2" class="text-center text-muted py-5">Your cart is empty.</td>
                        </tr>
                        <% } %>
              </tbody>

            </table>

            <!-- Coupon + Summary -->
            <div class="row justify-content-between mt-4 align-items-center">
              <div class="col-md-4">
                <% if (cart.appliedCoupon) { %>
                  <div class="border rounded-3 p-3 shadow-sm bg-white mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div>
                        <i class="bi bi-check-circle-fill text-success me-1"></i>
                        <span class="text-success fw-bold">‘<%= coupon.couponCode %>’</span>
                        <span class="text-muted">Applied</span>
                      </div>
                      <form action="/removeCoupon" method="POST" class="d-inline removeCoupon">
                                                        <input type="hidden" name="cartId" value="<%= cart._id %>">
                        <button type="submit" class="btn btn-link text-danger text-decoration-none p-0">Remove</button>
                      </form>
                    </div>

                    <p class="mb-2 text-start">
                      Saved <span class="fw-semibold text-success">₹<%= cart.totalDiscount.toFixed(2) %></span>
                      with this coupon
                    </p>

                    <hr class="my-2">

                    <div class="d-flex justify-content-between align-items-center">
                      <div class="text-start">
                        <i class="bi bi-ticket-perforated-fill text-success me-1"></i>
                        <span>Coupon Details</span>
                      </div>
                      <button type="button" class="btn btn-link  fw-semibold p-0"  style="color: #4beada;"  data-bs-toggle="modal"
                        data-bs-target="#couponDetailsModal">
                        View Details
                      </button>
                    </div>


                    <!--  Coupon Details Modal -->
                    <div class="modal fade" id="couponDetailsModal" tabindex="-1"
                      aria-labelledby="couponDetailsModalLabel" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 rounded-4 shadow-lg">
                          <div class="modal-header  text-white rounded-top-4 ">
                            <h5 class="modal-title fw-semibold  " id="couponDetailsModalLabel">
                              <i class="bi bi-ticket-perforated-fill me-2"></i>
                                <%= coupon.couponName %>
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                              aria-label="Close"></button>
                          </div>

                          <div class="modal-body ">
                            <p class="text-start"><strong>Code:</strong>
                              <%= cart.couponCode %>
                            </p>
                            <p class="text-start"><strong>Discount:</strong>
                              <% if (coupon.discountType==='Percentage' ) { %>
                                <%= coupon.discountValue %>% Off
                                  <% } else { %>
                                    ₹<%= coupon.discountValue %> Off
                                      <% } %>
                            </p>
                            <p class="text-start"><strong>Description:</strong>
                              <%= coupon.description || 'No description available.' %>
                            </p>
                            <p class="text-start"><strong>Maximum Discount:</strong>
                              <% if (coupon.discountType==='Percentage' ) { %>
                                ₹<%= coupon.maxDiscountAmount %>
                                  <% } else { %>
                                    ₹<%= coupon.discountValue %>
                                      <% } %>
                            </p>
                            <p class="text-start"><strong>Minimum purchase Amount:</strong>
                              <%= coupon.minPurchaseAmount%>
                            </p>
                              <p class="text-start"><strong>Uses Per Customer:</strong>
                              <%= coupon.usesPerCustomer %>
                            </p>

                            <hr>
                                <% if (coupon.scope === 'global') { %>
      This coupon is <strong>global</strong> — usable across all courses.<br>
         There are <strong><%= coupon.couponQuantity %></strong> total uses left
      and valid only until  <br><strong><%= coupon.endDateTime.toDateString() %></strong>.<br>
      <% if (coupon.usesPerCustomer && coupon.usesPerCustomer > 1) { %>
        Each user can use this coupon <strong><%= coupon.usesPerCustomer %></strong> times.<br>
        You can retrieve and use it again if unused before expiry.
      <% } %>

    <% } else if (coupon.scope === 'course') { %>
      This coupon is <strong>course-specific</strong> — valid only for certain courses.<br>
   There are <strong><%= coupon.couponQuantity %></strong> total uses left
      and valid only until <br> <strong><%= coupon.endDateTime.toDateString() %></strong>.<br>
      <% if (coupon.usesPerCustomer && coupon.usesPerCustomer > 1) { %>
        Each user can use it <strong><%= coupon.usesPerCustomer %></strong> times.<br>
        You can retrieve it anytime before expiry.
      <% } %>
    <% } %>
                          </div>
                        </div>
                      </div>
                    </div>


                  </div>
                  <% } else { %>
                    <form action="/applyCoupon" method="POST" class="coupon-form mt-3">
                      <div class="input-group">
                        <input type="text" name="couponCode" class="form-control" placeholder="Voucher code" required>
                        <button type="submit" class="btn btn-info text-white">
                          Redeem
                        </button>
                      </div>
                    </form>
                    <% } %>
              </div>


              <div class="col-md-5 text-end cart-summary">
                <p class="mb-1">Subtotal: <strong>$<%= cart.subTotal.toFixed(2) %></strong></p>
                <p class="mb-1">Coupon Discount: <strong>$<%= cart.totalDiscount.toFixed(2) %></strong></p>
                <h5 class="fw-bold mt-2">TOTAL: $<%= cart.total.toFixed(2) %>
                </h5>
                <button class="btn btn-info text-white w-100 rounded-pill mt-3">Place Order</button>
              </div>
            </div>
          </div>
        </section>




        <%- include("partials/flashalerts") %>

          <!-- Footer -->
          <%- include('partials/footer') %>


</body>
<script>
  document.querySelectorAll(".delete-form").forEach(form => {
    form.addEventListener("submit", function (e) {
      e.preventDefault();

      Swal.fire({
        title: "Are you sure?",
        text: "This course will be removed from your cart!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "Yes, remove it!"
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit(); // proceed only if confirmed
        }
      });
    });
  });
</script>

<script>
  document.querySelectorAll(".removeCoupon").forEach(form => {
    form.addEventListener("submit", function (e) {
      e.preventDefault();

      Swal.fire({
        title: "Are you sure?",
        text: "This will remove the coupon you applied!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "Yes, remove it!"
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit(); // proceed only if confirmed
        }
      });
    });
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

</html>